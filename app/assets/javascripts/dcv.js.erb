$(function() {
  /* rand banner img */
  /* unused for now 
  var $rbi = [];
  var $ielems = $('.thumbnail img'), icount = $ielems.length;
  $ielems.each(function() { 
    $rbi.push($ielems.attr('src'));
    if (!--icount) {
      ix = Math.floor($rbi.length*Math.random())
      $('#site-banner-left').css('background-image','url('+$rbi[ix]+')');
    }
  });
  */
  /* scroll to top function */
  $('body').on('click', '.totop', function() {
    $('body,html').animate({ scrollTop: 0 }, 500, 'swing');
    return false;
  });
  $('body').on('click', '#list-mode', function() {
      $('#content .col-sm-3').addClass('col-sm-12').addClass('list-view');
      $('#content .col-sm-3 .thumbnail').addClass('col-sm-2');
      $('#content .col-sm-3 .index_title').addClass('col-sm-9');
      $('#grid-mode').removeClass('btn-success').addClass('btn-default');
      $('#content .index-show-fields').removeClass('hidden');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#grid-mode', function() {
      $('#content .col-sm-3').removeClass('col-sm-12').removeClass('list-view');
      $('#content .col-sm-3 .thumbnail').removeClass('col-sm-2');
      $('#content .col-sm-3 .index_title').removeClass('col-sm-9');
      $('#list-mode').removeClass('btn-success').addClass('btn-default');
      $('#content .index-show-fields').addClass('hidden');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#unzoom-mode', function(){
     // hide the zooming stuff
      $('div#zoom-gallery').addClass('hidden');

      $('#child_items').removeClass('hidden');
      $('#zoom-mode').removeClass('btn-success').addClass('btn-default');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#zoom-mode', function(){
     // do some stuff with a data url
     if (!$.tileSources){
       $.djUrl = "http://iris.cul.columbia.edu:8888/view/";
       $.ajax({
        dataType: "json",
        url: this.getAttribute('data-url'),
        success: function(data){
          var sources = [];
          var children = data['children'] || [];
          var children_map = {};

          for (var i=0; i<children.length; i++) {
            var child = children[i];
            children_map[child['id']] = child;
          }
          $("a[rel='document-link']").each(function() {
            var child = null;
            var dataId = $(this).attr('data-id');
            for (var i=0; i< children.length; i++) {
              if (children[i]['contentids'].indexOf(dataId) > -1) {
                child = children[i];
                break;
              }
            }
            if (child && child['rft_id']) {
            //sources[sources.length] = new OpenSeadragon.DjTileSource($.djUrl, child['rft_id']);
            sources[sources.length] = new OpenSeadragon.CalculatedDjTileSource($.djUrl, child['rft_id'], child['width'], child['length']);
            }
          });
          $.tileSources = sources;
          $.navImages = {};
          // zoomIn buttons
          zoomIn = ($.navImages['zoomIn'] = {});
          zoomIn['REST'] = '<%= image_path("seadragon/zoomin_rest.png")%>';
          zoomIn['GROUP'] = '<%= image_path("seadragon/zoomin_grouphover.png")%>';
          zoomIn['HOVER'] = '<%= image_path("seadragon/zoomin_hover.png")%>';
          zoomIn['DOWN'] = '<%= image_path("seadragon/zoomin_pressed.png")%>';
          // zoomOut buttons
          zoomOut = ($.navImages['zoomOut'] = {});
          zoomOut['REST'] = '<%= image_path("seadragon/zoomout_rest.png")%>';
          zoomOut['GROUP'] = '<%= image_path("seadragon/zoomout_grouphover.png")%>';
          zoomOut['HOVER'] = '<%= image_path("seadragon/zoomout_hover.png")%>';
          zoomOut['DOWN'] = '<%= image_path("seadragon/zoomout_pressed.png")%>';
          // home buttons
          home = ($.navImages['home'] = {});
          home['REST'] = '<%= image_path("seadragon/home_rest.png")%>';
          home['GROUP'] = '<%= image_path("seadragon/home_grouphover.png")%>';
          home['HOVER'] = '<%= image_path("seadragon/home_hover.png")%>';
          home['DOWN'] = '<%= image_path("seadragon/home_pressed.png")%>';
          // fullpage buttons
          fullpage = ($.navImages['fullpage'] = {});
          fullpage['REST'] = '<%= image_path("seadragon/fullpage_rest.png")%>';
          fullpage['GROUP'] = '<%= image_path("seadragon/fullpage_grouphover.png")%>';
          fullpage['HOVER'] = '<%= image_path("seadragon/fullpage_hover.png")%>';
          fullpage['DOWN'] = '<%= image_path("seadragon/fullpage_pressed.png")%>';
          // previous buttons
          previous = ($.navImages['previous'] = {});
          previous['REST'] = '<%= image_path("seadragon/previous_rest.png")%>';
          previous['GROUP'] = '<%= image_path("seadragon/previous_grouphover.png")%>';
          previous['HOVER'] = '<%= image_path("seadragon/previous_hover.png")%>';
          fullpage['DOWN'] = '<%= image_path("seadragon/previous_pressed.png")%>';
          // next buttons
          next = ($.navImages['next'] = {});
          next['REST'] = '<%= image_path("seadragon/next_rest.png")%>';
          next['GROUP'] = '<%= image_path("seadragon/next_grouphover.png")%>';
          next['HOVER'] = '<%= image_path("seadragon/next_hover.png")%>';
          next['DOWN'] = '<%= image_path("seadragon/next_pressed.png")%>';
          OpenSeadragon({
            id:            "zoom-content",
            prefixUrl:     "",
            toolbar:       "zoom-toolbar",
            springStiffness:        10,
            showReferenceStrip:     true,
            autoHideControls:       false,
            showNavigator:  true,
            navImages: $.navImages,
            tileSources: $.tileSources
          });
        }
      });
    }
    // hide the non-zooming stuff
    $('#child_items').addClass('hidden');
    // OSD the zooming div
    $('div#zoom-gallery').removeClass('hidden');
    $('#unzoom-mode').removeClass('btn-success').addClass('btn-default');
    $(this).addClass('btn-success');
  });
  $('#search-navbar').find('.reset-btn').hover(function() {
      $('#appliedParams').find('.remove').addClass('btn-danger');
    }, function() {
      $('#appliedParams').find('.remove').removeClass('btn-danger');
  });
  $('#q').focus(function() {
    $('#search-navbar .input-group').css('box-shadow','0 0 18px #ccf');
  });
  $('#q').blur(function() {
    $('#search-navbar .input-group').css('box-shadow','none');
  });
  $('a.item-link').colorbox({
    maxHeight:"90%",
    maxWidth:"90%",
    opacity:".7",
    fixed:true,
    preloading: false,
    current:"{current} of {total}",
    title: function(){
      var otit = $(this).data('original-title');
      var dlb = '<div id="dlwrapper"><div class="btn-group dropup">' +
                '<button class="btn btn-link btn-lg dropdown-toggle" type="button" data-toggle="dropdown">' +
                '<i class="glyphicon glyphicon-download"></i></button><ul class="dropdown-menu pull-right">' +
                '<li><a href="#">Retrieving Download Links...</a></li></ul></div></div>';
      return otit+dlb;
    },
    onComplete: function(){
      var bsUrl = $(this).attr('data-bytestreams');
      loadByteStreams(bsUrl);
    },
  });
  $('#show_file_assets_checkbox').on('change', function(){
    window.location = decodeURIComponent($(this).attr('data-new-location'));
  });
});

function loadByteStreams(bsUrl) {
  $.ajax({
    dataType: "json",
    url: bsUrl,
    success: function(data){
      $('#dlwrapper ul.dropdown-menu').each(function(list){
        li_html = '';
        for(var i=0;i<data.length;i++){
          dlName = data[i]["title"] + '.' + data[i]["url"].match(/\.([^.]+)$/)[1];
          dlName += ' (' + data[i]["width"] + 'x' + data[i]["length"] + ')';
          li_html += '<li><a href="' + data[i]["url"] + '" target="_blank">' + dlName + '</a></li>'
        }
        $(this).html(li_html);
      });
    }
  });
}
//** CULTNBW START **/
  CULh_colorfg = '#000000'; // topnavbar foreground color. hex value. ex: #002B7F
  CULh_colorbg = '#444444'; // topnavbar background color. hex value. ex: #779BC3
  CULh_nobs = 1; // uncomment to NOT load our bootstrap javascript file and or use your own (v2.3.x required)
//** /CULTNBW END **/
