$(function() {
  /* rand banner img */
  /* unused for now 
  var $rbi = [];
  var $ielems = $('.thumbnail img'), icount = $ielems.length;
  $ielems.each(function() { 
    $rbi.push($ielems.attr('src'));
    if (!--icount) {
      ix = Math.floor($rbi.length*Math.random())
      $('#site-banner-left').css('background-image','url('+$rbi[ix]+')');
    }
  });
  */
  /* scroll to top function */
  $('body').on('click', '.totop', function() {
    $('body,html').animate({ scrollTop: 0 }, 500, 'swing');
    return false;
  });
  $('body').on('click', '#list-mode', function() {
      $('#content .col-sm-3').addClass('col-sm-12').addClass('list-view');
      $('#content .col-sm-3 .thumbnail').addClass('col-sm-2');
      $('#content .col-sm-3 .index_title').addClass('col-sm-9');
      $('#grid-mode').removeClass('btn-success').addClass('btn-default');
      $('#content .index-show-fields').removeClass('hidden');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#grid-mode', function() {
      $('#content .col-sm-3').removeClass('col-sm-12').removeClass('list-view');
      $('#content .col-sm-3 .thumbnail').removeClass('col-sm-2');
      $('#content .col-sm-3 .index_title').removeClass('col-sm-9');
      $('#list-mode').removeClass('btn-success').addClass('btn-default');
      $('#content .index-show-fields').addClass('hidden');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#unzoom-mode', function(){
     // hide the zooming stuff
      $('div#zoom-gallery').addClass('hidden');

      $('#child_items').removeClass('hidden');
      $('#zoom-mode').removeClass('btn-success').addClass('btn-default');
      $(this).addClass('btn-success');
  });
  $('body').on('click', '#zoom-mode', function(){
    switchToZoom();
  });
  $('body').on('click', '#inset-zoom-mode', function(){
    switchToZoom();
  });
  $('#search-navbar').find('.reset-btn').hover(function() {
      $('#appliedParams').find('.remove').addClass('btn-danger');
    }, function() {
      $('#appliedParams').find('.remove').removeClass('btn-danger');
  });
  $('#q').focus(function() {
    $('#search-navbar .input-group').css('box-shadow','0 0 18px #ccf');
  });
  $('#q').blur(function() {
    $('#search-navbar .input-group').css('box-shadow','none');
  });
  $('#show_file_assets_checkbox').on('change', function(){
    window.location = decodeURIComponent($(this).attr('data-new-location'));
  });
  $('.panel').on('shown.bs.collapse', function(e){
    $(this).children('i.more').removeClass('glyphicon-chevron-down');
    $(this).children('i.more').addClass('glyphicon-chevron-right');
  })
  $('.panel').on('hidden.bs.collapse', function(e){
    $(this).children('i.more').removeClass('glyphicon-chevron-down');
    $(this).children('i.more').addClass('glyphicon-chevron-right');
  })
});
function initZoomingViewer() {
  if (!$.navImages) {
    $.navImages = {};
    // zoomIn buttons
    zoomIn = ($.navImages['zoomIn'] = {});
    zoomIn['REST'] = '<%= image_path("seadragon/zoomin_rest.png")%>';
    zoomIn['GROUP'] = '<%= image_path("seadragon/zoomin_grouphover.png")%>';
    zoomIn['HOVER'] = '<%= image_path("seadragon/zoomin_hover.png")%>';
    zoomIn['DOWN'] = '<%= image_path("seadragon/zoomin_pressed.png")%>';
    // zoomOut buttons
    zoomOut = ($.navImages['zoomOut'] = {});
    zoomOut['REST'] = '<%= image_path("seadragon/zoomout_rest.png")%>';
    zoomOut['GROUP'] = '<%= image_path("seadragon/zoomout_grouphover.png")%>';
    zoomOut['HOVER'] = '<%= image_path("seadragon/zoomout_hover.png")%>';
    zoomOut['DOWN'] = '<%= image_path("seadragon/zoomout_pressed.png")%>';
    // home buttons
    home = ($.navImages['home'] = {});
    home['REST'] = '<%= image_path("seadragon/home_rest.png")%>';
    home['GROUP'] = '<%= image_path("seadragon/home_grouphover.png")%>';
    home['HOVER'] = '<%= image_path("seadragon/home_hover.png")%>';
    home['DOWN'] = '<%= image_path("seadragon/home_pressed.png")%>';
    // fullpage buttons
    fullpage = ($.navImages['fullpage'] = {});
    fullpage['REST'] = '<%= image_path("seadragon/fullpage_rest.png")%>';
    fullpage['GROUP'] = '<%= image_path("seadragon/fullpage_grouphover.png")%>';
    fullpage['HOVER'] = '<%= image_path("seadragon/fullpage_hover.png")%>';
    fullpage['DOWN'] = '<%= image_path("seadragon/fullpage_pressed.png")%>';
    // previous buttons
    previous = ($.navImages['previous'] = {});
    previous['REST'] = '<%= image_path("seadragon/previous_rest.png")%>';
    previous['GROUP'] = '<%= image_path("seadragon/previous_grouphover.png")%>';
    previous['HOVER'] = '<%= image_path("seadragon/previous_hover.png")%>';
    previous['DOWN'] = '<%= image_path("seadragon/previous_pressed.png")%>';
    // next buttons
    next = ($.navImages['next'] = {});
    next['REST'] = '<%= image_path("seadragon/next_rest.png")%>';
    next['GROUP'] = '<%= image_path("seadragon/next_grouphover.png")%>';
    next['HOVER'] = '<%= image_path("seadragon/next_hover.png")%>';
    next['DOWN'] = '<%= image_path("seadragon/next_pressed.png")%>';
  }
  // do some stuff with a data url
  if (!$.tileSources){
    $.djUrl = "http://iris.cul.columbia.edu:8888/view/";
    $.ajax({
      dataType: "json",
      url: $('#zoom-gallery').attr('data-url'),
      success: function(data){
        var sources = [];
        var children = data['children'] || [];
        var children_map = {};

        for (var i=0; i<children.length; i++) {
          var child = children[i];
          children_map[child['id']] = child;
        }
        $("#children-links a[rel='child']").each(function() {
          var child = null;
          var dataId = $(this).attr('data-id');
          for (var i=0; i< children.length; i++) {
            if (children[i]['contentids'].indexOf(dataId) > -1) {
              child = children[i];
              break;
            }
          }
          if (child && child['rft_id']) {
            $(this).attr('data-rftId',child['rft_id'])
            //sources[sources.length] = new OpenSeadragon.DjTileSource($.djUrl, child['rft_id']);
            sources[sources.length] = new OpenSeadragon.CalculatedDjTileSource($.djUrl, child['rft_id'], child['width'], child['length']);
          }
        });
        $.tileSources = sources;
        if ($.zoomingViewer) {
          $.zoomingViewer.open($.tileSources);
        } else {
          $.zoomingViewer = OpenSeadragon({
            id:            "zoom-content",
            prefixUrl:     "",
            springStiffness:        10,
            showReferenceStrip:     true,
            autoHideControls:       false,
            showNavigator:  true,
            tileSources: $.tileSources,
            zoomInButton:   "zoom-in-control",
            zoomOutButton:  "zoom-out-control",
            homeButton:     "zoom-home-control",
            fullPageButton: "zoom-full-control",
            nextButton:     "zoom-next-control",
            previousButton: "zoom-prev-control",
            showSequenceControl: true
          });
          $.zoomingViewer.addHandler('open',handleImageChange,null);
        }
      }
    });
  }

}
function handleImageChange(event) {
  var src = event.source;
  var tile = event.tileSource;
  var bsUrl = null;
  var dataId = "[none]";
  $("a[rel='child']").each(function(){
    if ($(this).attr('data-rftId') == src.imageID) {
      bsUrl = $(this).attr('data-bytestreams');
    }
  })
  loadByteStreams(bsUrl);
}

function loadByteStreams(bsUrl) {
  $.ajax({
    dataType: "json",
    url: bsUrl,
    success: function(data){
      $('#dlwrapper ul.dropdown-menu').each(function(list){
        li_html = '';
        for(var i=0;i<data.length;i++){
          dlName = data[i]["title"] + '.' + data[i]["url"].match(/\.([^.]+)$/)[1];
          dlName += ' (' + data[i]["width"] + 'x' + data[i]["length"] + ')';
          li_html += '<li><a href="' + data[i]["url"] + '" target="_blank">' + dlName + '</a></li>'
        }
        $(this).html(li_html);
      });
    }
  });
}

function favoriteChild(child) {
  var screenUrl = $(child).attr('href');
  var screenImg = $('#favorite-child img').first();
  var dataCounter = $(child).attr('data-counter');
  if (screenUrl != screenImg.attr('src')) {
    screenImg.attr('src', screenUrl);
    screenImg.attr('data-counter', dataCounter);
  }
}
//** CULTNBW START **/
  CULh_colorfg = '#000000'; // topnavbar foreground color. hex value. ex: #002B7F
  CULh_colorbg = '#444444'; // topnavbar background color. hex value. ex: #779BC3
  CULh_nobs = 1; // uncomment to NOT load our bootstrap javascript file and or use your own (v2.3.x required)
//** /CULTNBW END **/
